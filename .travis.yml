dist: xenial
language: minimal

services:
  - docker
git:
  submodules: false
env:
  global:
    - MAKEOPTS="-j4"
    - CACHE_DIR=${HOME}/persist
    - IMAGE_NAME=pycampers/micropython
    - IMAGE_TAG=$(travis/get-tag.sh)
    - IMAGE=${IMAGE_NAME}:${IMAGE_TAG}
    - IMAGE_TAR=${HOME}/persist/docker-image-${TRAVIS_COMMIT}.tar
cache:
  directories:
    - $CACHE_DIR

stages:
#  - name: build
  - name: test

jobs:
  include:
    - stage: build
      script:
#        - mkdir -p ${CACHE_DIR}

        - echo ${DOCKER_PASS} | docker login -u ${DOCKER_USER} --password-stdin
#        - docker load -i ${IMAGE_TAR} || true
        - docker pull ${IMAGE}

        - docker build --cache-from ${IMAGE} -t ${IMAGE} .

        - docker push ${IMAGE}
#        - docker save -o ${IMAGE_TAR} ${IMAGE}

    - stage: test
      env:
        matrix:
          - PORT=stm32
          - PORT=qemu-arm
          - PORT=unix-coverage
          - PORT=unix-standard
          - PORT=unix-nanobox
          - PORT=unix-stackless
          - PORT=windows
          - PORT=esp32
          - PORT=esp8266
          - PORT=nrf
          - PORT=bare-arm
          - PORT=cc3200
          - PORT=samd
          - PORT=teensy
      script:
#        - docker load -i ${IMAGE_TAR} || true
        - docker run -v ${PWD}:${PWD} -w ${PWD} ${IMAGE} travis/${PORT}.sh
