- pipeline: Build Dockerfile
  trigger_mode: ON_EVERY_PUSH
  ref_name: refs/heads/*
  ref_type: WILDCARD
  trigger_condition: ALWAYS

  actions:
    - action: Setup env
      execute_commands:
        - export
            IMAGE_NAME=pycampers/micropython
            TEMP_IMAGE_TAG=$CIRRUS_TASK_ID
            TEMP_IMAGE=$IMAGE_NAME:$TEMP_IMAGE_TAG
            RELEASE_IMAGE_TAG=$IMAGE_NAME:${BUDDY_EXECUTION_TAG:$BUDDY_EXECUTION_BRANCH}
            RELEASE_IMAGE=$IMAGE_NAME:$RELEASE_IMAGE_TAG
        - env

    - action: Build docker image
      type: DOCKERFILE
      dockerfile_path: Dockerfile
      repository: $IMAGE_NAME
      docker_image_tag: $TEMP_IMAGE
      login: $DOCKER_USERNAME
      password: $DOCKER_PASSWORD
      do_not_prune_images: true

    - action: Run Build port pipeline
      type: RUN_NEXT_PIPELINE
      next_project_name: micropython
      next_pipeline_name: Build port

- pipeline: Build port
  trigger_mode: MANUAL
  ref_type: NONE
  trigger_condition: ALWAYS

  actions:
    - action: Setup env
      execute_commands:
        - export
            IMAGE_NAME=pycampers/micropython
            TEMP_IMAGE_TAG=$CIRRUS_TASK_ID
            TEMP_IMAGE=$IMAGE_NAME:$TEMP_IMAGE_TAG
            RELEASE_IMAGE_TAG=$IMAGE_NAME:${BUDDY_EXECUTION_TAG:$BUDDY_EXECUTION_BRANCH}
            RELEASE_IMAGE=$IMAGE_NAME:$RELEASE_IMAGE_TAG
        - env

    - action: stm32
      type: BUILD
      docker_image_name: $IMAGE_NAME
      docker_image_tag: $TEMP_IMAGE_TAG
      execute_commands:
        - ci-scripts/stm32.sh

