version: v1.0
name: micropython build and test pipline

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Build docker image
    task:
      prologue:
        &prologue-commands
        commands:
          - checkout
          - export IMAGE_NAME=pycampers/micropython
          - export IMAGE_TAG=$(travis/get-tag.sh)
          - export IMAGE=$IMAGE_NAME:$IMAGE_TAG
          - echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
          - docker pull $IMAGE
      secrets:
        - name: docker-hub
      jobs:
        - name: Build docker image
          commands:
            - docker build --cache-from $IMAGE -t $IMAGE .
            - docker push $IMAGE

  - name: Build ports
    task:
      prologue:
        *prologue-commands
      env_vars:
        - name: MAKEOPTS
          value: -j4
      jobs:
        - name: Build ports
          matrix:
            - env_var: PORT
              values:
                - stm32
                - qemu-arm
                - unix-coverage
                - unix-standard
                - unix-nanobox
                - unix-stackless
                - windows
                - esp32
                - esp8266
                - nrf
                - bare-arm
                - cc3200
                - samd
                - teensy
          commands:
            - docker run -v $PWD:$PWD -w $PWD $IMAGE travis/${PORT}.sh
