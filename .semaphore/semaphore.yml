version: v1.0
name: micropython build and test pipline

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Build docker image
    task:
      prologue:
        commands:
          - checkout
          - IMG_TAG=$(.semaphore/get-img-tag.sh)
          - sudo -E cache restore docker-dir
      epilogue:
        commands:
          - sudo -E cache store docker-dir /var/lib/docker
      secrets:
        - name: docker-hub
      jobs:
        - name: Build docker-dir image
          commands:
            - echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
            - docker pull $IMG_TAG
            - docker build --cache-from $IMG_TAG -t $IMG_TAG .
            - docker push $IMG_TAG

  - name: Build ports
    task:
      prologue:
        commands:
          - checkout
          - IMG_TAG=$(.semaphore/get-img-tag.sh)
          - sudo -E cache restore docker-dir
      jobs:
        - name: Build stm32 port
          commands:
            - docker run -v $PWD:$PWD -w $PWD $IMG_TAG .semaphore/stm32.sh
