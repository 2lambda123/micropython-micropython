version: v1.0
name: micropython build and test pipline

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Build docker image
    task:
      prologue:
        &prologue-commands
        commands:
          - checkout
          - export RELEASE_IMAGE=$(ci-scripts/get-release-img.sh)
          - docker pull $RELEASE_IMAGE
      secrets:
        - name: docker-hub
      jobs:
        - name: Build docker image
          commands:
            - docker build --cache-from $RELEASE_IMAGE -t $RELEASE_IMAGE .
            - echo $DOCKER_PASS | docker login -u $DOCKER_USER --password-stdin
            - docker push $RELEASE_IMAGE
            - ./ci-scripts/build-all.sh
#  - name: Build ports
#    task:
#      prologue:
#        *prologue-commands
#      env_vars:
#        - name: MAKEOPTS
#          value: -j4
#      jobs:
#        - name: Build ports
#          matrix:
#            - env_var: PORT
#              values:
#                - stm32
#                - qemu-arm
#                - unix-coverage
#                - unix-standard
#                - unix-nanobox
#                - unix-stackless
#                - windows
#                - esp32
#                - esp8266
#                - nrf
#                - bare-arm
#                - cc3200
#                - samd
#                - teensy
#          commands:
#            - docker run -v $PWD:$PWD -w $PWD $RELEASE_IMAGE ci-scripts/${PORT}.sh
